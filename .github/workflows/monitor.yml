name: Website Monitor

on:
  schedule:
    - cron: '0 1 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4
    
    - name: Run monitor
      id: monitor
      run: |
        cat > check.py << 'EOF'
        import requests
        import json
        from datetime import datetime
        
        # 读取配置
        with open('sites_config.json', 'r') as f:
            config = json.load(f)
        
        print("开始检查网站...")
        results = []
        
        for site in config['sites']:
            if not site.get('enabled', True):
                continue
            try:
                r = requests.get(site['url'], timeout=15, headers={
                    'User-Agent': 'Mozilla/5.0 Website Monitor'
                })
                results.append(f"✅ {site['name']}: HTTP {r.status_code}")
                print(f"✅ {site['name']}: 成功访问")
            except Exception as e:
                results.append(f"❌ {site['name']}: {str(e)[:50]}")
                print(f"❌ {site['name']}: 访问失败")
        
        # 生成报告
        with open('report.txt', 'w') as f:
            f.write(f"# 网站监控报告\n")
            f.write(f"时间: {datetime.now()}\n\n")
            for r in results:
                f.write(f"{r}\n")
        
        print("报告已生成")
        EOF
        
        python check.py
    
    - name: Create Issue  
      if: success()
      uses: peter-evans/create-issue-from-file@v4
      with:
        title: "[监控报告] ${{ github.run_number }} - ${{ github.event_name }}"
        content-filepath: ./report.txt
        labels: monitor
